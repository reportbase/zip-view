//https://claude.ai/chat/1f5cd826-dbfe-446d-aa8c-4eb2f0c4c4af
//https://sqliteonline.com/

export default 
{
  async fetch(request, env, ctx) 
  {
      var headers = new Headers(
      {
        "Access-Control-Allow-Origin": "*",
        "content-type": "application/json;charset=UTF-8"
      }
    );

    var url = new URL(request.url); 
    const { DATABASE } = env; 

    var id = request.url.split("/").slice(-1)[0];
    var type = request.url.split("/").slice(-2)[0];
    if (type == "users")
    {
      INSERT INTO users (id, email)  
      VALUES (123, 'john@example.com')
      ON DUPLICATE KEY UPDATE 
        email = 'john@example.com';

      var k = DATABASE.prepare(
        `SELECT * FROM galleries WHERE id = ?`)
          .bind(id);
      var { results } = await k.all();           
      return new Response(
        results[0].json,{headers});    
    }
    else if (type == "galleries")
    {
      INSERT INTO galleries (id, json)
      VALUES (456, '{gallery data...}')
      ON DUPLICATE KEY UPDATE 
        json = '{gallery data...}';

      INSERT INTO user_galleries (user_id, gallery_id)
      SELECT u.id, 456
      FROM users u
      WHERE u.email = 'user@example.com'
        ON DUPLICATE KEY UPDATE gallery_id = 456;  
    }
    else if (type == "images")
    {
      INSERT INTO user_images (image_id, user_id) 
      VALUES (1234, (SELECT id FROM users WHERE email = 'user@example.com'))
      ON DUPLICATE KEY UPDATE user_id = (SELECT id FROM users WHERE email = 'user@example.com');      
    }
  },
};
